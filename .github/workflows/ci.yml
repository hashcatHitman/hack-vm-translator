# SPDX-FileCopyrightText: Copyright Â© 2025 hashcatHitman
#
# SPDX-License-Identifier: Apache-2.0 OR MIT

name: CI
permissions:
  contents: read

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["**"]
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_VET_VERSION: 0.10.2
  MSRV: 1.89.0

defaults:
  run:
    shell: bash

jobs:
  cargo-vet:
    name: Vet Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Install Rust
        run: rustup update stable && rustup default stable
      - name: Check cache for cargo-vet
        id: cache-cargo-vet
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: ~/.cargo/bin/cargo-vet
          key: cargo-vet-bin-${{ env.CARGO_VET_VERSION }}
      - if: ${{ steps.cache-cargo-vet.outputs.cache-hit != 'true' }}
        name: Install cargo-vet
        run: cargo install --locked --version ${CARGO_VET_VERSION} cargo-vet
      - name: Invoke cargo-vet
        run: cargo vet --locked

  quality-control:
    name: Quality Control
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Nightly Install
        run: rustup toolchain add nightly && rustup component add --toolchain nightly rustfmt clippy
      - name: Format Check (Nightly)
        run: cargo +nightly fmt --verbose --all --check
      - name: Clippy (Nightly)
        run: cargo +nightly clippy --locked --workspace --all-targets --all-features -- -D warnings -Zcrate-attr=feature"(strict_provenance_lints,unqualified_local_imports,must_not_suspend,multiple_supertrait_upcastable,non_exhaustive_omitted_patterns_lint,supertrait_item_shadowing)"

  build-test-msrv:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    name: Build & Test (${{ matrix.os }}) (MSRV)
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: MSRV Install
        run: rustup toolchain add ${MSRV}
      - name: Build
        run: cargo +${MSRV} build --verbose --workspace --all-targets --all-features --locked
      - name: Tests
        run: cargo +${MSRV} test --verbose --workspace --all-targets --all-features --locked
      - name: Doctests
        run: cargo +${MSRV} test --verbose --workspace --doc --all-features --locked

  build-test-nightly:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    name: Build & Test (${{ matrix.os }}) (Nightly)
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Build
        run: cargo +nightly build --verbose --workspace --all-targets --all-features --locked
      - name: Tests
        run: cargo +nightly test --verbose --workspace --all-targets --all-features --locked
      - name: Doctests
        run: cargo +nightly test --verbose --workspace --doc --all-features --locked
